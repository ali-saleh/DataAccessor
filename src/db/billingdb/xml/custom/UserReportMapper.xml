<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="db.billingdb.dao.custom.UserReportMapper">
	<resultMap id="SimpleUserMap" type="db.billingdb.model.custom.SimpleUser">
		<result column="user_id" property="id" jdbcType="INTEGER" />
		<result column="fullname" property="fullname" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="UserInfoMap" type="db.billingdb.model.custom.UserInfo"
		extends="SimpleUserMap">
		<result column="username" property="username" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="outstandingMap" type="db.billingdb.model.custom.OutstandingUser"
		extends="UserInfoMap">
		<result column="city" property="city" jdbcType="VARCHAR" />
		<result column="balance" property="balance" jdbcType="DOUBLE" />
	</resultMap>

	<resultMap id="customerMap" type="db.billingdb.model.custom.Customer"
		extends="UserInfoMap" />

	<select id="getSalesmenList" resultMap="SimpleUserMap"
		parameterType="int">
		select
		urm.user_id 'user_id',
		cf.content 'fullname'
		from
		user_role_map urm
		join contact c on urm.role_id = 9 AND c.user_id = urm.user_id AND
		c.deleted = false
		<if test="city != 0">
			AND c.city = #{city, jdbcType=INTEGER}
		</if>
		join contact_field cf on cf.contact_id = c.id AND cf.type_id = 432
	</select>

	<select id="getDistibutorList" resultMap="SimpleUserMap"
		parameterType="int">
		select
		urm.user_id 'user_id',
		cf.content 'fullname'
		from
		user_role_map urm
		join contact c on urm.role_id = 4 AND c.user_id = urm.user_id AND
		c.deleted = false
		<if test="city != 0">
			AND c.city = #{city, jdbcType=INTEGER}
		</if>
		join contact_field cf on cf.contact_id = c.id AND cf.type_id = 432
	</select>

	<select id="getUsersByName" resultMap="SimpleUserMap"
		parameterType="map">
		select
		c.user_id user_id,
		cf.content fullname
		from
		contact c,
		contact_field cf
		Where
		cf.contact_id = c.id
		<if test="city != 0">
			AND c.city = #{city, jdbcType=INTEGER}
		</if>
		AND
		cf.type_id = 432
		AND
		cf.content like #{name, jdbcType=VARCHAR}
	</select>

	<select id="getActiveUsers" parameterType="Date">
		select
		distinct
		po.user_id
		from
		purchase_order po
		where
		po.active_until &gt;
		#{date,
		jdbcType=TIMESTAMP}
		order by po.active_until desc
	</select>

	<select id="getAllCustomers" resultMap="customerMap">
		select
		urm.user_id
		'user_id',
		cf2.content 'username',
		cf1.content 'fullname'
		from
		user_role_map urm
		join contact c on urm.role_id = 5 AND c.user_id =
		urm.user_id AND
		c.deleted = false
		join contact_field cf1 on
		cf1.contact_id = c.id AND cf1.type_id = 432
		join contact_field cf2 on
		cf2.contact_id = c.id AND cf2.type_id = 434
	</select>

	<!-- <sql id="item_report_columns"> -->
	<!-- rpt.item_id item_id, -->
	<!-- rpt.description 'desc', -->
	<!-- sum(subqnt) qnt, -->
	<!-- count(distinct sub_ord_cnt) num_orders, -->
	<!-- (sum(sub_amt) -->
	<!-- <if test="vatRate != 0"> -->
	<!-- * (1.0 - #{vatRate,jdbcType=DOUBLE}) -->
	<!-- </if> -->
	<!-- ) as amount -->
	<!-- </sql> -->

	<!-- <select id="getItemReport" resultMap="ItemReportMap" -->
	<!-- parameterType="db.billingdb.model.custom.ItemReportCondition"> -->
	<!-- SELECT -->
	<!-- <include refid="item_report_columns" /> -->
	<!-- FROM -->
	<!-- (SELECT -->
	<!-- i_0.*, -->
	<!-- i_0.quantity as subqnt, -->
	<!-- op.order_id as sub_ord_cnt, -->
	<!-- i_0.amount + if(i_1.price is null, 0, (i_0.amount * if(i_1.price is -->
	<!-- null, - 1, -->
	<!-- sum(i_1.price) / 100))) -->
	<!-- as sub_amt -->
	<!-- FROM -->
	<!-- invoice_line i_0 -->
	<!-- Left -->
	<!-- outer join -->
	<!-- order_process op ON -->
	<!-- i_0.invoice_id=op.invoice_id -->
	<!-- Left outer -->
	<!-- join -->
	<!-- invoice_line i_1 ON -->
	<!-- i_0.invoice_id=i_1.invoice_id -->
	<!-- AND -->
	<!-- i_0.item_id not -->
	<!-- in -->
	<!-- (SELECT it.id from -->
	<!-- item it WHERE it.percentage is not null) -->
	<!-- AND -->
	<!-- i_1.item_id not in -->
	<!-- (SELECT -->
	<!-- it.id from -->
	<!-- item it WHERE it.percentage is -->
	<!-- null -->
	<!-- ) -->
	<!-- WHERE -->
	<!-- <if test="itemId != 0"> -->
	<!-- i_0.item_id = #{itemId,jdbcType=INTEGER} -->
	<!-- AND -->
	<!-- </if> -->
	<!-- i_0.invoice_id in -->
	<!-- (SELECT -->
	<!-- inv.id -->
	<!-- FROM -->
	<!-- invoice inv -->
	<!-- WHERE -->
	<!-- <trim prefix="(" suffix=")" prefixOverrides="AND"> -->

	<!-- <if test="startDate != null"> -->
	<!-- and inv.create_datetime &gt; -->
	<!-- #{startDate,jdbcType=TIMESTAMP} -->
	<!-- </if> -->
	<!-- <if test="endDate != null"> -->
	<!-- and inv.create_datetime &lt; -->
	<!-- #{endDate,jdbcType=TIMESTAMP} -->
	<!-- </if> -->
	<!-- <if test="currencyId != 0"> -->
	<!-- AND inv.currency_id = #{currencyId,jdbcType=INTEGER} -->
	<!-- </if> -->
	<!-- <choose> -->
	<!-- <when test="userId != 0"> -->
	<!-- AND inv.user_id = #{userId,jdbcType=INTEGER} -->
	<!-- </when> -->
	<!-- <otherwise> -->
	<!-- <if test="city != 0"> -->
	<!-- AND inv.user_id in (SELECT -->
	<!-- con.user_id -->
	<!-- FROM -->
	<!-- contact con -->
	<!-- WHERE -->
	<!-- con.city = #{city,jdbcType=INTEGER}) -->
	<!-- </if> -->
	<!-- </otherwise> -->
	<!-- </choose> -->
	<!-- AND -->
	<!-- <choose> -->
	<!-- <when test="deleted"> -->
	<!-- inv.deleted = 1 -->
	<!-- </when> -->
	<!-- <otherwise> -->
	<!-- inv.deleted = 0 -->
	<!-- </otherwise> -->
	<!-- </choose> -->
	<!-- </trim> -->
	<!-- AND inv.is_review = 0 -->
	<!-- ) -->
	<!-- group by -->
	<!-- i_0.invoice_id, -->
	<!-- i_0.item_id) rpt -->
	<!-- group by -->
	<!-- rpt.item_id; -->
	<!-- </select> -->
</mapper>
